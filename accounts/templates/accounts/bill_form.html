{% extends "accounts/base.html" %}
{% block content %}
<style>
/* (keep your existing CSS â€” unchanged from what you already use) */
body {
    background: linear-gradient(135deg, #9D6DC2 0%, #5A2D82 100%);
    font-family: "Poppins", sans-serif;
    color: #f0f0f0;
    margin: 0;
    padding: 0;
}
.page-container {
    background: #6D3A8E;
    border-radius: 16px;
    padding: 40px;
    box-shadow: 0 4px 15px rgba(90,45,130,0.25);
    max-width: 850px;
    margin: 40px auto;
    border: 1px solid rgba(255,255,255,0.08);
}
.page-title { font-size: 28px; color: #FFFADA; font-weight: 700; margin-bottom: 10px; text-shadow: 0 1px 4px rgba(0,0,0,0.3); }
.page-subtitle { color: #FFCD7B; font-size: 15px; margin-bottom: 25px; }
form { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
label { display:block; font-weight:600; color:#FFFADA; margin-bottom:6px; font-size:14px; }
input[type="text"], input[type="number"], input[type="date"], select, textarea {
    width:100%; padding:10px 12px; border:1px solid #E9ECEF; border-radius:8px; font-size:14px; background:#FFFADA; color:#2a2a2a; transition:all .3s;
}
input:focus, select:focus, textarea:focus { border-color:#FFA719; box-shadow:0 0 6px rgba(255,167,25,0.6); outline:none; }
textarea { resize:vertical; min-height:80px; }
.form-actions { grid-column:1 / -1; display:flex; justify-content:flex-end; gap:15px; margin-top:30px; }
.btn { background: linear-gradient(135deg,#FFA719,#FFCD7B); color:#2a2a2a; border:none; border-radius:8px; padding:10px 20px; font-weight:600; cursor:pointer; }
.btn-secondary { background:#7A3DB8; color:#fff; padding:10px 20px; border-radius:8px; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; }
.small-note { color:#FFCD7B; font-size:0.85rem; margin-top:6px; display:block; }
.readonly-display { background: rgba(255,255,255,0.95); color:#2a2a2a; padding:10px 12px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); }
@media (max-width:600px){ .page-container { padding:25px } .page-title{ font-size:24px } }
</style>

<div class="page-container">
    <h2 class="page-title">{% if form.instance.pk %}Edit Bill{% else %}Add New Bill{% endif %}</h2>
    <p class="page-subtitle">Fill in the bill details below.</p>

    <form method="POST" novalidate>
        {% csrf_token %}
        {{ form.non_field_errors }}

        <!-- Tenant (kept exactly as Django form field) -->
        {% if 'tenant' in form.fields %}
        <div>
            <label for="{{ form.tenant.id_for_label }}">Tenant</label>
            {{ form.tenant }}
            {% if form.tenant.errors %}
                <span class="small-note">{{ form.tenant.errors.0 }}</span>
            {% endif %}
        </div>
        {% endif %}

        <!-- Unit (kept exactly as Django form field) -->
        {% if 'unit' in form.fields %}
        <div>
            <label for="{{ form.unit.id_for_label }}">Unit</label>
            {{ form.unit }}
            {% if form.unit.errors %}
                <span class="small-note">{{ form.unit.errors.0 }}</span>
            {% endif %}
        </div>
        {% endif %}

        <!-- Billing month / date (your model uses `month`) -->
        {% if 'month' in form.fields %}
        <div>
            <label for="{{ form.month.id_for_label }}">Billing Month / Date</label>
            {{ form.month }}
            {% if form.month.errors %}
                <span class="small-note">{{ form.month.errors.0 }}</span>
            {% endif %}
        </div>
        {% endif %}

        <!-- Room price (will be auto-set in view but show editable so user can override) -->
        {% if 'room_price' in form.fields %}
        <div>
            <label for="{{ form.room_price.id_for_label }}">Room Price (â‚±)</label>
            {{ form.room_price }}
            {% if form.room_price.errors %}
                <span class="small-note">{{ form.room_price.errors.0 }}</span>
            {% endif %}
        </div>
        {% endif %}

        <!-- Water bill -->
        {% if 'water_bill' in form.fields %}
        <div>
            <label for="{{ form.water_bill.id_for_label }}">Water Bill (â‚±)</label>
            {{ form.water_bill }}
            {% if form.water_bill.errors %}
                <span class="small-note">{{ form.water_bill.errors.0 }}</span>
            {% endif %}
        </div>
        {% endif %}

        <!-- Previous meter -->
        {% if 'previous_meter' in form.fields %}
        <div>
            <label for="{{ form.previous_meter.id_for_label }}">Previous Meter</label>
            {{ form.previous_meter }}
            {% if form.previous_meter.errors %}
                <span class="small-note">{{ form.previous_meter.errors.0 }}</span>
            {% endif %}
        </div>
        {% endif %}

        <!-- Current meter -->
        {% if 'current_meter' in form.fields %}
        <div>
            <label for="{{ form.current_meter.id_for_label }}">Current Meter</label>
            {{ form.current_meter }}
            {% if form.current_meter.errors %}
                <span class="small-note">{{ form.current_meter.errors.0 }}</span>
            {% endif %}
        </div>
        {% endif %}

        <!-- Visitors charge -->
        {% if 'visitors_charge' in form.fields %}
        <div>
            <label for="{{ form.visitors_charge.id_for_label }}">Visitors Charge (â‚±)</label>
            {{ form.visitors_charge }}
            {% if form.visitors_charge.errors %}
                <span class="small-note">{{ form.visitors_charge.errors.0 }}</span>
            {% endif %}
        </div>
        {% endif %}

        <!-- Read-only computed fields shown to user (client-side calculation).
             They have NO name attribute so they won't be POSTed (server calculates on save). -->
        <div>
            <label>Electric Bill (â‚±) â€” calculated</label>
            <div id="electric_bill_display" class="readonly-display">â‚±0.00</div>
        </div>

        <div>
            <label>Total Rent (â‚±) â€” estimated</label>
            <div id="total_rent_display" class="readonly-display">â‚±0.00</div>
            <small class="small-note">Server will recompute and save final values on submit.</small>
        </div>

        <div class="form-actions">
            <a href="{% url 'bill_list' %}" class="btn-secondary">Cancel</a>
            <button type="submit" class="btn">ðŸ’¾ Save Bill</button>
        </div>
    </form>
</div>

<script>
// Client-side helper: compute electric bill and estimated total
(function(){
    // helper to safely parse number
    function toNum(v){ v = parseFloat(String(v).replace(/,/g,'')); return isFinite(v) ? v : 0; }

    function q(name){ return document.querySelector('[name="'+name+'"]'); }
    var prevEl = q('previous_meter');
    var currEl = q('current_meter');
    var roomEl = q('room_price');
    var waterEl = q('water_bill');
    var visitorsEl = q('visitors_charge');

    var electricDisplay = document.getElementById('electric_bill_display');
    var totalDisplay = document.getElementById('total_rent_display');

    function recalc(){
        var prev = prevEl ? toNum(prevEl.value) : 0;
        var curr = currEl ? toNum(currEl.value) : 0;
        var room = roomEl ? toNum(roomEl.value) : 0;
        var water = waterEl ? toNum(waterEl.value) : 0;
        var visitors = visitorsEl ? toNum(visitorsEl.value) : 0;

        var electric = 0;
        if(curr >= prev){ electric = (curr - prev) * 11; } else { electric = 0; }
        var total = room + water + electric + visitors;

        electricDisplay.textContent = "â‚±" + electric.toFixed(2);
        totalDisplay.textContent = "â‚±" + total.toFixed(2);
    }

    [prevEl, currEl, roomEl, waterEl, visitorsEl].forEach(function(el){
        if(!el) return;
        el.addEventListener('input', recalc);
        el.addEventListener('change', recalc);
    });

    // initial compute (if values pre-filled)
    window.addEventListener('load', recalc);
})();
</script>
{% endblock %}
